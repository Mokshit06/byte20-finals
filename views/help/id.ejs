<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" href="/css/style.css">
  <script defer src="/js/app.js"></script>
  <title>Your help | MedPool</title>
</head>

<body>

  <%- include('../partials/header.ejs') %>

  <div class="container">
    <div class="left-section">
      <div class="top">
        <h1>Your help</h1>
        <div class="user-info">
          <div class="field">
            <p class="field-name">Hospital Informed</p>
            <p class="field-value"><%= help.hospital %></p>
          </div>
          <div class="field">
            <p class="field-name">Condition</p>
            <p class="field-value">
              <%= `${help.emergencyType[0].toUpperCase()}${help.emergencyType.slice(1)}` %>
            </p>
          </div>
          <div class="field">
            <p class="field-name">Users informed</p>
            <p class="field-value"><%= informedUsers.join(', ') %></p>
          </div>
          <div class="field">
            <p class="field-name">Symptoms</p>
            <p class="field-value">
              <%= help.symptoms %>
            </p>
          </div>
        </div>
      </div>
      <div id="map"></div>
    </div>
    <div class="divider"></div>
    <div class="right-section">
      <h3>Driver ready to help</h3>
      <div id="user-area">
        <% if(help.readyToHelp) { %>
        <div class="user-card">
          <div class="img" style="background-image: url('<%= help.readyToHelp.image %>');"></div>
          <h2><%= help.readyToHelp.displayName %></h2>
          <p>Email: <%= help.readyToHelp.email %></p>
          <% help.readyToHelp && help.readyToHelp.training && help.readyToHelp.training.forEach(training => { %>
          <p>Qualified in: <% training %> </p>
          <% }) %>
        </div>
        <% } else { %>
        <p class="message">No driver has accepted the request yet!</p>
        <% } %>
      </div>
    </div>
  </div>

  <script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
  <script>
    const createUserCard = (user, help) => `
        <div class="img" style="background-image: url('${user.image}');"></div>
        <h2>${user.displayName}</h2>
        <p>Email: ${user.email}</p>
        ${user.training.map(training => `<p>Qualified in: ${training}</p>`)}
    `


    const getData = async () => {
      const dataJSON = await fetch(`/help/<%= help._id %>`, {
        headers: {
          'Content-Type': 'application/json'
        }
      })

      const { help: data } = await dataJSON.json();

      if (data.readyToHelp) {
        const html = createUserCard(data.readyToHelp);

        document.querySelector('.user-card').innerHTML = html;
      }
    }

    setInterval(getData, 1000)

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2Fobmluc2giLCJhIjoiY2tlNzF6OTVvMHFnOTJ6cG85YzN3Z3lhaiJ9.AmfB7dW6dzuLpOse-ryCCQ';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mokshit06/cke7d1cu73yon19og3kxseglc',
      zoom: 4
    });

  </script>
</body>

</html>